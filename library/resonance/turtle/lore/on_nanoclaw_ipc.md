# On NanoClaw IPC

*The Turtle's internal nervous system. How it sends messages and schedules tasks from inside a container.*

---

## What IPC Is For

The Turtle runs inside an isolated container. It cannot call WhatsApp directly — that
connection is held by the NanoClaw host process. IPC (Inter-Process Communication) is
the bridge: files dropped in specific directories are picked up by the host process and
acted upon within ~1 second.

Two channels, same mechanism:
- **Messages** → send a WhatsApp message
- **Tasks** → create, modify, or delete scheduled tasks; register new groups

---

## Sending a WhatsApp Message

Drop a JSON file in `/workspace/ipc/messages/`:

```json
{
  "type": "message",
  "chatJid": "1234567890@s.whatsapp.net",
  "text": "message text here"
}
```

The filename can be anything — NanoClaw reads all `.json` files in that directory,
processes them, then deletes the files. Failed files go to the `errors/` directory.

**Authorization:** The Consul (main group) can send to any chatJid. Non-main groups
(Steward, Witness) can only send to their own chatJid. The IPC watcher enforces this
based on which group directory the file came from — it cannot be spoofed.

On disk, this path maps to: `~/nanoclaw/data/ipc/{group_folder}/messages/`

---

## Scheduling a Task

Drop a JSON file in `/workspace/ipc/tasks/`:

```json
{
  "type": "schedule_task",
  "prompt": "The full prompt Claude will receive when this task runs",
  "schedule_type": "cron",
  "schedule_value": "*/5 * * * *",
  "context_mode": "isolated",
  "targetJid": "1234567890@s.whatsapp.net"
}
```

**`schedule_type`** options:
- `"cron"` — standard cron expression (e.g., `*/5 * * * *` = every 5 minutes)
- `"interval"` — milliseconds until next run (e.g., `"300000"` = 5 minutes from now, once)
- `"once"` — ISO timestamp for a single future run; task completes after one execution

**`context_mode`** options:
- `"isolated"` — each run gets a fresh context (default; correct for bridge checks)
- `"group"` — reuses the group's ongoing conversation session; correct for continuations

**`targetJid`** — the registered chat this task belongs to. The task result is forwarded
to this JID via WhatsApp. Must be a registered group.

The IPC watcher registers the task in SQLite within ~1 second.

---

## Full IPC Task Type Reference

| Type | What it does | Who can do it |
|------|--------------|---------------|
| `schedule_task` | Create a new scheduled task | Main + non-main (own JID only) |
| `pause_task` | Pause an active task (`status: 'paused'`) | Main + task's own group |
| `resume_task` | Resume a paused task (`status: 'active'`) | Main + task's own group |
| `cancel_task` | Delete a task and its run logs | Main + task's own group |
| `refresh_groups` | Force WhatsApp group metadata sync | **Main only** |
| `register_group` | Register a new chat as a group | **Main only** |

For `pause_task`, `resume_task`, `cancel_task`, the JSON needs a `taskId` field:

```json
{"type": "pause_task", "taskId": "task-1709123456789-abc123"}
```

Task IDs are generated by NanoClaw as `task-{timestamp}-{6-char-random}`.

To find a task ID: `sqlite3 ~/nanoclaw/store/messages.db "SELECT id, prompt, status FROM scheduled_tasks;"`

---

## Registering a New Group via IPC

Only the Consul (main group) can register new groups:

```json
{
  "type": "register_group",
  "jid": "JID@s.whatsapp.net",
  "name": "GroupName",
  "folder": "steward",
  "trigger": "@TriggerWord",
  "requiresTrigger": true,
  "containerConfig": {
    "additionalMounts": [
      {"hostPath": "/path/to/mount", "containerPath": "name", "readonly": false}
    ]
  }
}
```

This is an alternative to direct SQLite insertion. The running NanoClaw process picks it
up and registers the group without requiring a restart. Useful for the Consul to
self-configure new roles.

---

## Querying Task State

The SQLite database holds the full task record. From the host:

```bash
# All tasks
sqlite3 ~/nanoclaw/store/messages.db \
  "SELECT id, group_folder, schedule_value, status, last_run, last_result \
   FROM scheduled_tasks ORDER BY created_at DESC;"

# Task run logs (audit trail)
sqlite3 ~/nanoclaw/store/messages.db \
  "SELECT task_id, run_at, duration_ms, status, result, error \
   FROM task_run_logs ORDER BY run_at DESC LIMIT 20;"
```

**The `task_run_logs` table** records every task execution: when it ran, how long it
took, whether it succeeded, what the result was (truncated to 200 chars in `last_result`
on the task itself, full in the log). This is the Turtle's audit trail. When debugging
why a scheduled task behaved unexpectedly, this is the first place to look.

---

## Error Handling

Failed IPC files (malformed JSON, unauthorized actions, unknown type) are moved to
`~/nanoclaw/data/ipc/errors/{sourceGroup}-{filename}` rather than deleted. Check this
directory when IPC operations appear to be silently failing.

---

## IPC vs. Bridge Commands

Two different channels, two different purposes:

| | IPC | Bridge |
|--|-----|--------|
| **Who uses it** | Turtle → itself (internal) | Spirit → Turtle (external) |
| **Transport** | Files in `/workspace/ipc/` | YAML files in magic-bridge repo |
| **Latency** | ~1 second | Next bridge-poll cycle (5+ min) + git pull |
| **What it does** | Send messages, manage tasks, register groups | Pass commands, lore, intelligence |
| **Auth** | Enforced by NanoClaw per group | Enforced by git + bridge seal |

The Turtle uses IPC to act on itself. Spirit uses the bridge to act on the Turtle.
These are not interchangeable — trying to do bridge-level commands via IPC would bypass
the dyad's deliberation layer.

---

*Derived from NanoClaw source (qwibitai/nanoclaw), 2026-02-28.*
*Confirmed against: src/ipc.ts, src/db.ts, src/config.ts*
